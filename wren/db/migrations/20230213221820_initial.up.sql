-- create "owners" table
CREATE TABLE "owners" ("id" uuid NOT NULL, "created_at" timestamptz NOT NULL, "name" character varying NULL, "contact" character varying NULL, "client_id" character varying NOT NULL, PRIMARY KEY ("id"));
-- create "kaskada_tables" table
CREATE TABLE "kaskada_tables" ("id" uuid NOT NULL, "created_at" timestamptz NOT NULL, "updated_at" timestamptz NOT NULL, "name" character varying NOT NULL, "description" character varying NULL, "entity_key_column_name" character varying NOT NULL, "time_column_name" character varying NOT NULL, "subsort_column_name" character varying NULL, "grouping_id" character varying NULL, "source" bytea NOT NULL, "merged_schema" bytea NULL, "owner_kaskada_tables" uuid NOT NULL, PRIMARY KEY ("id"), CONSTRAINT "kaskada_tables_owners_kaskada_tables" FOREIGN KEY ("owner_kaskada_tables") REFERENCES "owners" ("id") ON DELETE CASCADE);
-- create index "kaskadatable_name_owner_kaskada_tables" to table: "kaskada_tables"
CREATE UNIQUE INDEX "kaskadatable_name_owner_kaskada_tables" ON "kaskada_tables" ("name", "owner_kaskada_tables");
-- create "data_versions" table
CREATE TABLE "data_versions" ("id" bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY, "created_at" timestamptz NOT NULL, "external_revision" character varying NULL, "kaskada_table_data_versions" uuid NULL, "owner_data_versions" uuid NOT NULL, PRIMARY KEY ("id"), CONSTRAINT "data_versions_kaskada_tables_data_versions" FOREIGN KEY ("kaskada_table_data_versions") REFERENCES "kaskada_tables" ("id") ON DELETE CASCADE, CONSTRAINT "data_versions_owners_data_versions" FOREIGN KEY ("owner_data_versions") REFERENCES "owners" ("id") ON DELETE CASCADE);
-- create "kaskada_files" table
CREATE TABLE "kaskada_files" ("id" uuid NOT NULL, "created_at" timestamptz NOT NULL, "path" character varying NOT NULL, "identifier" character varying NOT NULL, "valid_from_version" bigint NOT NULL, "valid_to_version" bigint NULL, "schema" bytea NULL, "type" character varying NOT NULL DEFAULT 'parquet', "kaskada_table_kaskada_files" uuid NOT NULL, PRIMARY KEY ("id"), CONSTRAINT "kaskada_files_kaskada_tables_kaskada_files" FOREIGN KEY ("kaskada_table_kaskada_files") REFERENCES "kaskada_tables" ("id") ON DELETE CASCADE);
-- create index "kaskadafile_identifier_kaskada_table_kaskada_files" to table: "kaskada_files"
CREATE UNIQUE INDEX "kaskadafile_identifier_kaskada_table_kaskada_files" ON "kaskada_files" ("identifier", "kaskada_table_kaskada_files");
-- create "kaskada_queries" table
CREATE TABLE "kaskada_queries" ("id" uuid NOT NULL, "created_at" timestamptz NOT NULL, "updated_at" timestamptz NULL, "expression" character varying NOT NULL, "data_token_id" uuid NOT NULL, "query" bytea NULL, "views" bytea NULL, "config" bytea NULL, "state" character varying NOT NULL DEFAULT 'UNSPECIFIED', "metrics" bytea NULL, "compile_response" bytea NULL, "owner_kaskada_queries" uuid NOT NULL, PRIMARY KEY ("id"), CONSTRAINT "kaskada_queries_owners_kaskada_queries" FOREIGN KEY ("owner_kaskada_queries") REFERENCES "owners" ("id") ON DELETE CASCADE);
-- create "kaskada_query_results" table
CREATE TABLE "kaskada_query_results" ("id" uuid NOT NULL, "created_at" timestamptz NOT NULL, "path" character varying NOT NULL, "type" character varying NOT NULL DEFAULT 'UNSPECIFIED', "kaskada_query_kaskada_query_results" uuid NOT NULL, PRIMARY KEY ("id"), CONSTRAINT "kaskada_query_results_kaskada_queries_kaskada_query_results" FOREIGN KEY ("kaskada_query_kaskada_query_results") REFERENCES "kaskada_queries" ("id") ON DELETE CASCADE);
-- create "materializations" table
CREATE TABLE "materializations" ("id" uuid NOT NULL, "created_at" timestamptz NOT NULL, "name" character varying NOT NULL, "description" character varying NULL, "expression" character varying NOT NULL, "with_views" bytea NOT NULL, "destination" bytea NOT NULL, "schema" bytea NOT NULL, "slice_request" bytea NOT NULL, "analysis" bytea NOT NULL, "owner_materializations" uuid NOT NULL, PRIMARY KEY ("id"), CONSTRAINT "materializations_owners_materializations" FOREIGN KEY ("owner_materializations") REFERENCES "owners" ("id") ON DELETE CASCADE);
-- create index "materialization_name_owner_materializations" to table: "materializations"
CREATE UNIQUE INDEX "materialization_name_owner_materializations" ON "materializations" ("name", "owner_materializations");
-- create "prepare_jobs" table
CREATE TABLE "prepare_jobs" ("id" uuid NOT NULL, "created_at" timestamptz NOT NULL, "updated_at" timestamptz NULL, "slice_plan" bytea NULL, "slice_hash" bytea NOT NULL, "prepare_cache_buster" integer NOT NULL, "state" character varying NOT NULL DEFAULT 'UNSPECIFIED', "kaskada_table_prepare_jobs" uuid NOT NULL, PRIMARY KEY ("id"), CONSTRAINT "prepare_jobs_kaskada_tables_prepare_jobs" FOREIGN KEY ("kaskada_table_prepare_jobs") REFERENCES "kaskada_tables" ("id") ON DELETE CASCADE);
-- create "materialization_dependencies" table
CREATE TABLE "materialization_dependencies" ("id" uuid NOT NULL, "dependency_type" character varying NOT NULL, "dependency_name" character varying NOT NULL, "dependency_id" uuid NULL, "materialization_dependencies" uuid NOT NULL, PRIMARY KEY ("id"), CONSTRAINT "materialization_dependencies_materializations_dependencies" FOREIGN KEY ("materialization_dependencies") REFERENCES "materializations" ("id") ON DELETE CASCADE);
-- create "compute_snapshots" table
CREATE TABLE "compute_snapshots" ("id" uuid NOT NULL, "created_at" timestamptz NOT NULL, "data_version_id" bigint NOT NULL, "snapshot_cache_buster" integer NOT NULL, "plan_hash" bytea NOT NULL, "max_event_time" bigint NOT NULL, "path" character varying NOT NULL, "owner_compute_snapshots" uuid NOT NULL, PRIMARY KEY ("id"), CONSTRAINT "compute_snapshots_owners_compute_snapshots" FOREIGN KEY ("owner_compute_snapshots") REFERENCES "owners" ("id") ON DELETE CASCADE);
-- create "kaskada_table_compute_snapshots" table
CREATE TABLE "kaskada_table_compute_snapshots" ("kaskada_table_id" uuid NOT NULL, "compute_snapshot_id" uuid NOT NULL, PRIMARY KEY ("kaskada_table_id", "compute_snapshot_id"), CONSTRAINT "kaskada_table_compute_snapshots_kaskada_table_id" FOREIGN KEY ("kaskada_table_id") REFERENCES "kaskada_tables" ("id") ON DELETE CASCADE, CONSTRAINT "kaskada_table_compute_snapshots_compute_snapshot_id" FOREIGN KEY ("compute_snapshot_id") REFERENCES "compute_snapshots" ("id") ON DELETE CASCADE);
-- create "data_tokens" table
CREATE TABLE "data_tokens" ("id" uuid NOT NULL, "created_at" timestamptz NOT NULL, "data_version_id" bigint NOT NULL, "kaskada_table_id" uuid NOT NULL, "owner_data_tokens" uuid NOT NULL, PRIMARY KEY ("id"), CONSTRAINT "data_tokens_owners_data_tokens" FOREIGN KEY ("owner_data_tokens") REFERENCES "owners" ("id") ON DELETE CASCADE);
-- create "kaskada_views" table
CREATE TABLE "kaskada_views" ("id" uuid NOT NULL, "created_at" timestamptz NOT NULL, "name" character varying NOT NULL, "description" character varying NULL, "expression" character varying NOT NULL, "data_type" bytea NOT NULL, "analysis" bytea NOT NULL, "owner_kaskada_views" uuid NOT NULL, PRIMARY KEY ("id"), CONSTRAINT "kaskada_views_owners_kaskada_views" FOREIGN KEY ("owner_kaskada_views") REFERENCES "owners" ("id") ON DELETE CASCADE);
-- create index "kaskadaview_name_owner_kaskada_views" to table: "kaskada_views"
CREATE UNIQUE INDEX "kaskadaview_name_owner_kaskada_views" ON "kaskada_views" ("name", "owner_kaskada_views");
-- create "prepared_files" table
CREATE TABLE "prepared_files" ("id" uuid NOT NULL, "created_at" timestamptz NOT NULL, "path" character varying NOT NULL, "min_event_time" bigint NOT NULL, "max_event_time" bigint NOT NULL, "row_count" bigint NOT NULL, "valid_from_version" bigint NOT NULL, "valid_to_version" bigint NULL, "metadata_path" character varying NULL, "kaskada_table_prepared_files" uuid NOT NULL, "prepare_job_prepared_files" uuid NOT NULL, PRIMARY KEY ("id"), CONSTRAINT "prepared_files_kaskada_tables_prepared_files" FOREIGN KEY ("kaskada_table_prepared_files") REFERENCES "kaskada_tables" ("id") ON DELETE CASCADE, CONSTRAINT "prepared_files_prepare_jobs_prepared_files" FOREIGN KEY ("prepare_job_prepared_files") REFERENCES "prepare_jobs" ("id") ON DELETE NO ACTION);
-- create "view_dependencies" table
CREATE TABLE "view_dependencies" ("id" uuid NOT NULL, "dependency_type" character varying NOT NULL, "dependency_name" character varying NOT NULL, "dependency_id" uuid NULL, "kaskada_view_dependencies" uuid NOT NULL, PRIMARY KEY ("id"), CONSTRAINT "view_dependencies_kaskada_views_dependencies" FOREIGN KEY ("kaskada_view_dependencies") REFERENCES "kaskada_views" ("id") ON DELETE CASCADE);
-- create "prepare_job_kaskada_files" table
CREATE TABLE "prepare_job_kaskada_files" ("prepare_job_id" uuid NOT NULL, "kaskada_file_id" uuid NOT NULL, PRIMARY KEY ("prepare_job_id", "kaskada_file_id"), CONSTRAINT "prepare_job_kaskada_files_prepare_job_id" FOREIGN KEY ("prepare_job_id") REFERENCES "prepare_jobs" ("id") ON DELETE CASCADE, CONSTRAINT "prepare_job_kaskada_files_kaskada_file_id" FOREIGN KEY ("kaskada_file_id") REFERENCES "kaskada_files" ("id") ON DELETE CASCADE);
